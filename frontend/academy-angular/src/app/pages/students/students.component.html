<section class="students-page" dir="rtl">
  <!-- Toolbar: search + view toggle + admin controls -->
  <div class="toolbar container">
    <div class="search-box">
      <input type="text" [(ngModel)]="query" (keydown.enter)="onSearch()" [placeholder]="'search_students' | t" [attr.aria-label]="('search' | t)"/>
      <button class="search-btn" type="button" (click)="onSearch()">{{ 'search' | t }}</button>
    </div>
    
    <!-- Admin Controls -->
    <div class="admin-controls" *ngIf="isAdmin$ | async">
      <button class="add-student-btn" (click)="showAddStudentForm()">
        <svg viewBox="0 0 24 24" width="18" height="18"><path d="M12 5v14M5 12h14"/></svg>
        {{ 'add_new_student' | t }}
      </button>
    </div>
    
    <div class="view-toggle" role="group" [attr.aria-label]="('search' | t)">
      <button [class.active]="view==='grid'" (click)="view='grid'" [attr.aria-label]="('view_grid' | t)">
        <!-- grid icon -->
        <svg viewBox="0 0 24 24" width="20" height="20"><path d="M3 3h8v8H3zM13 3h8v8h-8zM3 13h8v8H3zM13 13h8v8h-8z"/></svg>
      </button>
      <button [class.active]="view==='list'" (click)="view='list'" [attr.aria-label]="('view_list' | t)">
        <!-- list icon -->
        <svg viewBox="0 0 24 24" width="20" height="20"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
      </button>
    </div>
  </div>

  <!-- Categories Chips -->
  <div class="chips container">
    <button
      *ngFor="let cat of categories"
      class="chip"
      [class.active]="selectedCategory===cat"
      (click)="selectedCategory=cat"
    >{{ cat }}</button>
  </div>

  <div *ngIf="loading" class="container loading">{{ 'loading_plain' | t }}</div>
  <div *ngIf="error" class="container error">{{ error }}</div>

  <!-- No Students Message -->
  <div *ngIf="!loading && !error && students.length === 0" class="container no-students">
    <div class="no-students-content">
      <div class="no-students-icon">👥</div>
      <h3>{{ 'no_students_title' | t }}</h3>
      <p>{{ 'no_students_desc' | t }}</p>
      <button class="refresh-btn" (click)="fetchStudents()">{{ 'refresh_page' | t }}</button>
    </div>
  </div>

  <!-- Cards Grid -->
  <div class="cards container" [class.list]="view==='list'" *ngIf="!loading && !error && students.length > 0">
    <article class="student-card" *ngFor="let s of pagedStudents">
      <div class="badge" [attr.data-status]="s.status">{{ s.status }}</div>
      <div class="card-media">
        <div class="avatar">
          <span>{{ s.name.charAt(0) }}</span>
        </div>
      </div>
      <div class="card-body">
        <h3 class="title">{{ s.name }}</h3>
        <p class="email">{{ s.email }}</p>
        <div class="meta">
          <span class="item">
            <svg viewBox="0 0 24 24" width="18" height="18"><path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
            {{ s.phone }}
          </span>
          <span class="dot"></span>
          <span class="item">
            <svg viewBox="0 0 24 24" width="18" height="18"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            {{ s.joinDate }}
          </span>
        </div>
        
        <!-- معلومات إضافية -->
        <div class="student-info">
          <div class="info-item">
            <strong>{{ 'academy' | t }}</strong> {{ getAcademyName(s.academyId) }}
          </div>
          <div class="info-item">
            <strong>{{ 'branch' | t }}</strong> {{ getBranchName(s.branchId) }}
          </div>
          <div class="info-item" *ngIf="s.lastLogin">
            <strong>{{ 'last_login' | t }}</strong> {{ s.lastLogin }}
          </div>
        </div>
        <div class="card-actions">
          <button class="cta" routerLink="/students/data" [queryParams]="{id: s.id}">{{ 'view_details' | t }}</button>
          
          <!-- Admin Actions -->
          <div class="admin-actions" *ngIf="isAdmin$ | async">
            <button class="edit-btn" (click)="showEditStudentForm(s)" [title]="'edit_student' | t">
              <svg viewBox="0 0 24 24" width="16" height="16"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            </button>
            <button class="delete-btn" (click)="deleteStudent(s)" [title]="'delete_student' | t">
              <svg viewBox="0 0 24 24" width="16" height="16"><path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14z"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
            </button>
          </div>
        </div>
      </div>
    </article>
  </div>

  <!-- Pagination Controls -->
  <div class="container" *ngIf="!loading && !error && total > pageSize" style="display:flex;gap:8px;justify-content:center;align-items:center;margin:16px 0;">
    <button (click)="prevPage()" [disabled]="page<=1">{{ 'prev' | t }}</button>
    <span>{{ ('page_of' | t).replace('{{page}}', page) .replace('{{total}}', totalPages) }}</span>
    <button (click)="nextPage()" [disabled]="page>=totalPages">{{ 'next' | t }}</button>
  </div>

  <!-- Add New Student Modal -->
  <div class="modal-overlay" *ngIf="showAddForm" (click)="cancelForm()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ 'add_student_modal_title' | t }}</h3>
        <button class="close-btn" (click)="cancelForm()">×</button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="addStudent()">
          <div class="form-row">
            <div class="form-group">
              <label for="firstName">{{ 'first_name' | t }}</label>
              <input type="text" id="firstName" [(ngModel)]="newStudent.firstName" name="firstName" required>
            </div>
            <div class="form-group">
              <label for="lastName">{{ 'last_name' | t }}</label>
              <input type="text" id="lastName" [(ngModel)]="newStudent.lastName" name="lastName" required>
            </div>
          </div>
          
          <div class="form-group">
            <label for="email">{{ 'email' | t }}</label>
            <input type="email" id="email" [(ngModel)]="newStudent.email" name="email" required>
          </div>
          
          <div class="form-group">
            <label for="phone">{{ 'phone' | t }}</label>
            <input type="tel" id="phone" [(ngModel)]="newStudent.phone" name="phone">
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="academyId">{{ 'academy' | t }}</label>
              <select id="academyId" [(ngModel)]="newStudent.academyId" name="academyId" required>
                <option value="">{{ 'choose_academy' | t }}</option>
                <option *ngFor="let academy of academies" [value]="academy.id || academy.Id">
                  {{ getAcademyName(academy.id || academy.Id) }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label for="branchId">{{ 'branch' | t }}</label>
              <select id="branchId" [(ngModel)]="newStudent.branchId" name="branchId" required>
                <option value="">{{ 'choose_branch' | t }}</option>
                <option *ngFor="let branch of branches" [value]="branch.id || branch.Id">
                  {{ getBranchName(branch.id || branch.Id) }}
                </option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label for="status">{{ 'status' | t }}</label>
            <select id="status" [(ngModel)]="newStudent.status" name="status" required>
              <option value="نشط">{{ 'active' | t }}</option>
              <option value="غير نشط">{{ 'inactive' | t }}</option>
              <option value="معلق">{{ 'suspended' | t }}</option>
            </select>
          </div>
          
          <div class="form-actions">
            <button type="button" class="cancel-btn" (click)="cancelForm()">{{ 'cancel_btn' | t }}</button>
            <button type="submit" class="submit-btn" [disabled]="loading">{{ 'submit_add_student' | t }}</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Student Modal -->
  <div class="modal-overlay" *ngIf="showEditForm" (click)="cancelForm()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ 'edit_student_title' | t }}</h3>
        <button class="close-btn" (click)="cancelForm()">×</button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="updateStudent()">
          <div class="form-row">
            <div class="form-group">
              <label for="edit-firstName">{{ 'first_name' | t }}</label>
              <input type="text" id="edit-firstName" [(ngModel)]="newStudent.firstName" name="edit-firstName" required>
            </div>
            <div class="form-group">
              <label for="edit-lastName">{{ 'last_name' | t }}</label>
              <input type="text" id="edit-lastName" [(ngModel)]="newStudent.lastName" name="edit-lastName" required>
            </div>
          </div>
          
          <div class="form-group">
            <label for="edit-email">{{ 'email' | t }}</label>
            <input type="email" id="edit-email" [(ngModel)]="newStudent.email" name="edit-email" required>
          </div>
          
          <div class="form-group">
            <label for="edit-phone">{{ 'phone' | t }}</label>
            <input type="tel" id="edit-phone" [(ngModel)]="newStudent.phone" name="edit-phone">
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="edit-academyId">{{ 'academy' | t }}</label>
              <select id="edit-academyId" [(ngModel)]="newStudent.academyId" name="edit-academyId" required>
                <option value="">{{ 'choose_academy' | t }}</option>
                <option *ngFor="let academy of academies" [value]="academy.id || academy.Id">
                  {{ getAcademyName(academy.id || academy.Id) }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label for="edit-branchId">{{ 'branch' | t }}</label>
              <select id="edit-branchId" [(ngModel)]="newStudent.branchId" name="edit-branchId" required>
                <option value="">{{ 'choose_branch' | t }}</option>
                <option *ngFor="let branch of branches" [value]="branch.id || branch.Id">
                  {{ getBranchName(branch.id || branch.Id) }}
                </option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label for="edit-status">{{ 'status' | t }}</label>
            <select id="edit-status" [(ngModel)]="newStudent.status" name="edit-status" required>
              <option value="نشط">{{ 'active' | t }}</option>
              <option value="غير نشط">{{ 'inactive' | t }}</option>
              <option value="معلق">{{ 'suspended' | t }}</option>
            </select>
          </div>
          
          <div class="form-actions">
            <button type="button" class="cancel-btn" (click)="cancelForm()">{{ 'cancel_btn' | t }}</button>
            <button type="submit" class="submit-btn" [disabled]="loading">{{ 'save_changes_btn' | t }}</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>
