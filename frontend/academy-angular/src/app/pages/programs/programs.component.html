<section class="relative isolate overflow-hidden" dir="rtl">
  <div class="absolute inset-0 -z-10 animated-gradient opacity-90"></div>
  <div class="absolute inset-0 z-0 bg-black/55"></div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-14 md:py-20 lg:py-28 relative z-10">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-white">{{ 'programs_nav' | t }}</h1>
      <button *ngIf="isAdmin" class="academy-button rounded-full" (click)="addProgram()">{{ 'add_new_program' | t }}</button>
    </div>

    <div *ngIf="loading" class="text-center text-white py-10">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
      {{ 'loading_plain' | t }}
    </div>
    <div *ngIf="error && !loading" class="text-center text-white py-10">
      {{ error }}
    </div>

    <div class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-2xl p-4 sm:p-6" *ngIf="!loading">
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-white programs-table">
          <thead>
            <tr class="text-right text-white/80">
              <th class="p-2">{{ 'name_ar' | t:'الاسم (ع)' }}</th>
              <th class="p-2">{{ 'name_en' | t:'الاسم (EN)' }}</th>
              <th class="p-2">{{ 'desc' | t:'الوصف' }}</th>
              <th class="p-2">{{ 'actions' | t:'الإجراءات' }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let p of programs" class="border-t border-white/10">
              <td class="p-2">{{ p?.title || p?.programNameL1 || p?.name }}</td>
              <td class="p-2">{{ p?.programNameL2 || '' }}</td>
              <td class="p-2 description-cell">{{ p?.description || '' }}</td>
              <td class="p-2 actions-cell">
                <div class="flex gap-2 actions-group">
                  <button class="btn-xs bg-green-600 hover:bg-green-700 text-white">{{ 'view_details' | t:'عرض' }}</button>
                  <ng-container *ngIf="isAdmin">
                    <button class="btn-xs" (click)="editProgram(p)">{{ 'edit' | t:'تعديل' }}</button>
                    <button class="btn-xs" (click)="deleteProgram(p)">{{ 'delete' | t:'حذف' }}</button>
                  </ng-container>
                </div>
              </td>
            </tr>
            <tr *ngIf="!programs.length">
              <td class="p-4 text-center text-white/70" colspan="4">{{ 'no_programs' | t:'لا توجد برامج.' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modal: Add/Edit Program -->
    <div class="modal-overlay" *ngIf="showAddForm" (click)="cancelForm()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ editingProgram ? ('edit_program_title' | t) : ('add_new_program' | t) }}</h3>
          <button class="close-btn" (click)="cancelForm()">×</button>
        </div>
        <div class="modal-body">
          <form (ngSubmit)="saveProgram()" #programForm="ngForm">
            <div class="form-group">
              <label for="programMaster">{{ 'choose_main_program_req' | t }}</label>
              <select id="programMaster" name="programMaster" [(ngModel)]="newProgram.programMasterId" required>
                <option value="">{{ 'choose_main_program_opt' | t }}</option>
                <option *ngFor="let m of programMasters" [value]="m.id">{{ m.title }}</option>
              </select>
            </div>

            <div class="form-group">
              <label for="programNameL1">{{ 'name_ar_3_70' | t }}</label>
              <input type="text" id="programNameL1" name="programNameL1" [(ngModel)]="newProgram.programNameL1" required minlength="3" maxlength="70">
            </div>

            <div class="form-group">
              <label for="programNameL2">{{ 'name_en_optional' | t }}</label>
              <input type="text" id="programNameL2" name="programNameL2" [(ngModel)]="newProgram.programNameL2">
            </div>

            <div class="form-group">
              <label for="description">{{ 'desc_optional' | t }}</label>
              <textarea id="description" name="description" rows="4" [(ngModel)]="newProgram.description"></textarea>
            </div>

            <div class="form-actions">
              <button type="button" class="cancel-btn" (click)="cancelForm()">{{ 'cancel_btn' | t }}</button>
              <button type="submit" class="submit-btn" [disabled]="!programForm.form.valid || loading">
                {{ loading ? ('saving' | t) : ('save_changes_btn' | t) }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>
