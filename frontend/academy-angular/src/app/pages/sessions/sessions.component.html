<section class="relative isolate overflow-hidden" dir="rtl">
  <div class="absolute inset-0 -z-10 animated-gradient opacity-90"></div>
  <div class="absolute inset-0 z-0 bg-black/55"></div>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-14 lg:py-20 relative z-10">
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
      <h1 class="text-xl sm:text-2xl lg:text-3xl xl:text-4xl font-extrabold text-white flex items-center gap-2">
        <svg viewBox="0 0 24 24" width="24" height="24" class="text-white"><path d="M8 7h8M6 11h12M4 15h16M6 19h12" stroke="currentColor" fill="none"/></svg>
        تقويم المشاريع
      </h1>
      <div class="flex items-center gap-2" *ngIf="isAdmin$ | async">
        <button class="add-session-btn" (click)="openCreateForm()">إضافة مشروع</button>
      </div>
      <div class="flex items-center gap-2">
        <button class="search-btn" (click)="goPrev()">السابق</button>
        <div class="text-white/90 font-semibold text-center">{{ currentMonth | date:'MMMM yyyy':'':'ar-EG' }}</div>
        <button class="search-btn" (click)="goNext()">التالي</button>
      </div>
    </div>
    
    <div *ngIf="usingDefaultData" class="mb-4 p-3 bg-yellow-500/20 border border-yellow-500/30 rounded-lg text-white">
      ⚠️ عرض بيانات افتراضية - لا توجد بيانات متاحة من الخادم
    </div>
    
    <div *ngIf="loading" class="text-center text-white py-10">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
      {{ 'loading_plain' | t }}
    </div>
    <div *ngIf="error && !loading" class="text-center text-white py-10">
      {{ error }}
  </div>

    <div class="calendar-container" *ngIf="!loading">
      <div class="calendar-header">
        <div *ngFor="let i of [6,0,1,2,3,4,5]" class="calendar-header-cell">{{ (i | weekdayName) }}</div>
      </div>
      <div class="calendar-grid">
        <ng-container *ngFor="let day of (currentMonth | monthDays : 6)">
          <div class="calendar-day"
               [class.outside]="day.getMonth() !== currentMonth.getMonth()"
               [class.today]="(day | date:'yyyy-MM-dd':'':'ar-EG') === (today | date:'yyyy-MM-dd':'':'ar-EG')"
               (click)="selectedDate = day">
            <div class="calendar-day-top">
              <div class="calendar-day-number">{{ day | date:'d':'':'ar-EG' }}</div>
        </div>
            <div class="calendar-day-body">
              <div *ngFor="let s of projects | byDate:day : 'startDate' | slice:0:1" class="calendar-badge">{{ s.title }}</div>
              <div *ngIf="(projects | byDate:day : 'startDate').length > 1" class="calendar-more">+{{ (projects | byDate:day : 'startDate').length - 1 }}</div>
          </div>
          </div>
        </ng-container>
      </div>
  </div>

    <!-- Selected day summary -->
    <div *ngIf="selectedDate" class="mt-4 border-t border-white/20 pt-3">
      <div class="flex items-center justify-between mb-2">
        <div class="text-white font-semibold text-sm sm:text-base">
          مشاريع يوم {{ selectedDate | date:'fullDate':'':'ar-EG' }}
  </div>
        <button class="search-btn" (click)="selectedDate=null">إغلاق</button>
      </div>
      <div class="grid gap-2">
        <div *ngFor="let s of (projects | byDate:selectedDate : 'startDate')" class="p-2 sm:p-3 rounded-lg border border-white/30 bg-white/10 text-white">
          <div class="font-medium mb-1 truncate text-sm sm:text-base">{{ s.title }}</div>
          <div *ngIf="s.description" class="text-xs mb-1 line-clamp-2">{{ s.description }}</div>
          <div class="text-xs">
            <div>تاريخ البداية: {{ s.startDate ? (s.startDate | date:'mediumDate':'':'ar-EG') : 'غير محدد' }}</div>
            <div>تاريخ النهاية: {{ s.endDate ? (s.endDate | date:'mediumDate':'':'ar-EG') : 'غير محدد' }}</div>
          </div>
      </div>
    </div>
  </div>

    <!-- Add/Edit Project Modal -->
    <div class="modal-overlay" *ngIf="isFormOpen" (click)="cancelForm()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
          <h3>{{ selectedProject ? 'تعديل المشروع' : 'إضافة مشروع' }}</h3>
        <button class="close-btn" (click)="cancelForm()">×</button>
      </div>
      <div class="modal-body">
          <form (ngSubmit)="saveProject(formModel)" #form="ngForm">
            <div class="form-group">
              <label for="ProjectNameL1">اسم المشروع (عربي) *</label>
              <input id="ProjectNameL1" name="ProjectNameL1" [(ngModel)]="formModel.ProjectNameL1" required minlength="3" maxlength="70" />
            </div>
          <div class="form-group">
              <label for="ProjectNameL2">اسم المشروع (إنجليزي)</label>
              <input id="ProjectNameL2" name="ProjectNameL2" [(ngModel)]="formModel.ProjectNameL2" maxlength="70" />
          </div>
          <div class="form-group">
              <label for="ProjectStart">تاريخ البداية *</label>
              <input id="ProjectStart" name="ProjectStart" type="date" [(ngModel)]="formModel.ProjectStart" required />
          </div>
          <div class="form-group">
              <label for="ProjectEnd">تاريخ النهاية</label>
              <input id="ProjectEnd" name="ProjectEnd" type="date" [(ngModel)]="formModel.ProjectEnd" />
          </div>
          <div class="form-group">
              <label for="Description">الوصف</label>
              <textarea id="Description" name="Description" rows="3" [(ngModel)]="formModel.Description"></textarea>
          </div>
          <div class="form-actions">
              <button type="button" class="cancel-btn" (click)="cancelForm()">إلغاء</button>
              <button type="submit" class="submit-btn" [disabled]="isSubmitting">{{ isSubmitting ? 'جاري الحفظ...' : 'حفظ' }}</button>
          </div>
        </form>
        </div>
      </div>
    </div>
  </div>
</section>

