<section class="sessions-page" dir="rtl">
  <!-- Toolbar: search + view toggle + admin controls -->
  <div class="toolbar container">
    <div class="search-box">
      <input type="text" [(ngModel)]="query" (keydown.enter)="onSearch()" [placeholder]="'search_sessions' | t" [attr.aria-label]="('search' | t)"/>
      <button class="search-btn" type="button" (click)="onSearch()">{{ 'search' | t }}</button>
    </div>
    
    <!-- Admin Controls -->
    <div class="admin-controls" *ngIf="isAdmin$ | async">
      <button class="add-session-btn" (click)="showAddSessionForm()">
        <svg viewBox="0 0 24 24" width="18" height="18"><path d="M12 5v14M5 12h14"/></svg>
        {{ 'add_new_session' | t }}
      </button>
    </div>
    
    <div class="view-toggle" role="group" [attr.aria-label]="('search' | t)">
      <button [class.active]="view==='grid'" (click)="view='grid'" [attr.aria-label]="('view_grid' | t)">
        <!-- grid icon -->
        <svg viewBox="0 0 24 24" width="20" height="20"><path d="M3 3h8v8H3zM13 3h8v8h-8zM3 13h8v8H3zM13 13h8v8h-8z"/></svg>
      </button>
      <button [class.active]="view==='list'" (click)="view='list'" [attr.aria-label]="('view_list' | t)">
        <!-- list icon -->
        <svg viewBox="0 0 24 24" width="20" height="20"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
      </button>
    </div>
  </div>

  <!-- Categories Chips -->
  <div class="chips container">
    <button
      *ngFor="let cat of categories"
      class="chip"
      [class.active]="selectedCategory===cat"
      (click)="selectedCategory=cat"
    >{{ cat }}</button>
  </div>

  <div *ngIf="loading" class="container loading">{{ 'loading_plain' | t }}</div>
  <div *ngIf="error" class="container error">{{ error }}</div>

  <!-- No Sessions Message -->
  <div *ngIf="!loading && !error && sessions.length === 0" class="container no-sessions">
    <div class="no-sessions-content">
      <div class="no-sessions-icon">📚</div>
      <h3>{{ 'no_sessions_title' | t }}</h3>
      <p>{{ 'no_sessions_desc' | t }}</p>
      <button class="refresh-btn" (click)="fetchSessions()">{{ 'refresh_page' | t }}</button>
    </div>
  </div>

  <!-- Cards Grid -->
  <div class="cards container" [class.list]="view==='list'" *ngIf="!loading && !error && sessions.length > 0">
    <article class="session-card" *ngFor="let s of pagedSessions">
      <div class="badge" [attr.data-level]="s.level">{{ s.level }}</div>
      <div class="card-media">
        <img [src]="getSessionImage(s)" alt="{{ s.title }}" loading="lazy" (error)="$event.target.src='assets/images/program_placeholder-BXZ7ZM7h.png'"/>
        <div class="play-icon">
          <svg viewBox="0 0 24 24" width="26" height="26"><path d="M8 5v14l11-7z"/></svg>
        </div>
      </div>
      <div class="card-body">
        <h3 class="title">{{ s.title }}</h3>
        <p class="desc">{{ s.description }}</p>
        <div class="meta">
          <span class="item">
            <svg viewBox="0 0 24 24" width="18" height="18"><path d="M12 7v6l4 2"/></svg>
            {{ s.durationWeeks }} {{ 'weeks' | t }}
          </span>
          <span class="dot"></span>
          <span class="item">
            <svg viewBox="0 0 24 24" width="18" height="18"><path d="M16 11c1.7 0 3-1.8 3-4s-1.3-4-3-4-3 1.8-3 4 1.3 4 3 4zm-8 0c1.7 0 3-1.8 3-4S9.7 3 8 3 5 4.8 5 7s1.3 4 3 4zm0 2c-2.8 0-5 2.2-5 5v1h10v-1c0-2.8-2.2-5-5-5z"/></svg>
            {{ s.students | number }} {{ 'students_lbl' | t }}
          </span>
          <span class="dot"></span>
          <span class="item">
            <svg viewBox="0 0 24 24" width="18" height="18"><path d="m12 17.3 5.5 3.2-1.4-6.1 4.7-4.1-6.2-.5L12 4l-2.6 5.8-6.2.5 4.7 4.1-1.4 6.1z"/></svg>
            {{ s.rating }}
          </span>
        </div>
        
        <!-- معلومات إضافية -->
        <div class="session-info" *ngIf="s.programsContentMasterId || s.sessionNo">
          <div class="info-item" *ngIf="s.programsContentMasterId">
            <strong>{{ 'main_program' | t }}</strong> {{ getProgramsContentMasterName(s.programsContentMasterId) }}
          </div>
          <div class="info-item" *ngIf="s.sessionNo">
            <strong>{{ 'session_number' | t }}</strong> {{ s.sessionNo }}
          </div>
        </div>
        <div class="card-actions">
          <button class="cta" routerLink="/register">{{ 'start_learning' | t }}</button>
          
          <!-- Admin Actions -->
          <div class="admin-actions" *ngIf="isAdmin$ | async">
            <button class="edit-btn" (click)="showEditSessionForm(s)" [title]="'edit_session' | t">
              <svg viewBox="0 0 24 24" width="16" height="16"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            </button>
            <button class="delete-btn" (click)="deleteSession(s)" [title]="'delete_session' | t">
              <svg viewBox="0 0 24 24" width="16" height="16"><path d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14z"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
            </button>
          </div>
        </div>
      </div>
    </article>
  </div>

  <!-- Pagination Controls -->
  <div class="container" *ngIf="!loading && !error && total > pageSize" style="display:flex;gap:8px;justify-content:center;align-items:center;margin:16px 0;">
    <button (click)="prevPage()" [disabled]="page<=1">{{ 'prev' | t }}</button>
    <span>{{ ('page_of' | t).replace('{{page}}', page) .replace('{{total}}', totalPages) }}</span>
    <button (click)="nextPage()" [disabled]="page>=totalPages">{{ 'next' | t }}</button>
  </div>

  <!-- Add New Session Modal -->
  <div class="modal-overlay" *ngIf="showAddForm" (click)="cancelForm()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ 'add_session_modal_title' | t }}</h3>
        <button class="close-btn" (click)="cancelForm()">×</button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="addSession()">
          <div class="form-group">
            <label for="sessionNameL1">{{ 'name_ar_3_70' | t }}</label>
            <input type="text" id="sessionNameL1" [(ngModel)]="newSession.sessionNameL1" name="sessionNameL1" required minlength="3" maxlength="70">
            <small>{{ 'must_be_3_70' | t }}</small>
          </div>
          
          <div class="form-group">
            <label for="sessionNameL2">{{ 'name_en_optional' | t }}</label>
            <input type="text" id="sessionNameL2" [(ngModel)]="newSession.sessionNameL2" name="sessionNameL2">
          </div>
          
          <div class="form-group">
            <label for="sessionNo">{{ 'session_number' | t }}</label>
            <input type="number" id="sessionNo" [(ngModel)]="newSession.sessionNo" name="sessionNo" min="0">
          </div>
          
          <div class="form-group">
            <label for="sessionDescription">{{ 'desc_optional' | t }}</label>
            <textarea id="sessionDescription" [(ngModel)]="newSession.sessionDescription" name="sessionDescription" rows="4"></textarea>
          </div>
          
          <div class="form-actions">
            <button type="button" class="cancel-btn" (click)="cancelForm()">{{ 'cancel_btn' | t }}</button>
            <button type="submit" class="submit-btn" [disabled]="loading">{{ 'submit_add_session' | t }}</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Session Modal -->
  <div class="modal-overlay" *ngIf="showEditForm" (click)="cancelForm()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ 'edit_session_title' | t }}</h3>
        <button class="close-btn" (click)="cancelForm()">×</button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="updateSession()">
          <div class="form-group">
            <label for="edit-sessionNameL1">{{ 'name_ar_3_70' | t }}</label>
            <input type="text" id="edit-sessionNameL1" [(ngModel)]="newSession.sessionNameL1" name="edit-sessionNameL1" required minlength="3" maxlength="70">
            <small>{{ 'must_be_3_70' | t }}</small>
          </div>
          
          <div class="form-group">
            <label for="edit-sessionNameL2">{{ 'name_en_optional' | t }}</label>
            <input type="text" id="edit-sessionNameL2" [(ngModel)]="newSession.sessionNameL2" name="edit-sessionNameL2">
          </div>
          
          <div class="form-group">
            <label for="edit-sessionNo">{{ 'session_number' | t }}</label>
            <input type="number" id="edit-sessionNo" [(ngModel)]="newSession.sessionNo" name="edit-sessionNo" min="0">
          </div>
          
          <div class="form-group">
            <label for="edit-sessionDescription">{{ 'desc_optional' | t }}</label>
            <textarea id="edit-sessionDescription" [(ngModel)]="newSession.sessionDescription" name="edit-sessionDescription" rows="4"></textarea>
          </div>
          
          <div class="form-actions">
            <button type="button" class="cancel-btn" (click)="cancelForm()">{{ 'cancel_btn' | t }}</button>
            <button type="submit" class="submit-btn" [disabled]="loading">{{ 'save_changes_btn' | t }}</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>
