<!-- Loading State -->
<section *ngIf="loading" class="relative isolate overflow-hidden">
  <div class="absolute inset-0 -z-10 animated-gradient opacity-90"></div>
  <div class="absolute inset-0 z-0 bg-black/55"></div>
  <div class="flex items-center justify-center min-h-screen relative z-10">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
      <p class="text-white/90">{{ isRtl ? 'جاري التحميل...' : 'Loading...' }}</p>
    </div>
  </div>
</section>

<!-- Not Authenticated State -->
<section *ngIf="!studentData || !isAuthenticated" class="relative isolate overflow-hidden">
  <div class="absolute inset-0 -z-10 animated-gradient opacity-90"></div>
  <div class="absolute inset-0 z-0 bg-black/55"></div>
  <div class="flex items-center justify-center min-h-screen relative z-10">
    <div class="text-center bg-white/10 backdrop-blur-sm border border-white/20 rounded-2xl p-8 max-w-md mx-4">
      <svg class="w-16 h-16 text-white mx-auto mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
      </svg>
      <h2 class="text-2xl font-bold text-white mb-4">
        {{ isRtl ? 'تسجيل الدخول مطلوب' : 'Login Required' }}
      </h2>
      <p class="text-white/80 mb-6">
        {{ isRtl 
          ? 'يجب عليك تسجيل الدخول لعرض ملفك الشخصي'
          : 'You need to login to view your profile'
        }}
      </p>
      <p class="text-white/60 text-sm mb-6">
        {{ isRtl 
          ? 'حالة المصادقة: ' + (isAuthenticated ? 'مسجل دخول' : 'غير مسجل دخول')
          : 'Auth Status: ' + (isAuthenticated ? 'Logged In' : 'Not Logged In')
        }}
      </p>
      <div class="flex flex-col sm:flex-row gap-3">
        <button 
          class="academy-button rounded-full px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white transition-all duration-300"
          (click)="router.navigate(['/login'])"
        >
          {{ isRtl ? 'تسجيل الدخول' : 'Login' }}
        </button>
        <button 
          class="rounded-full border-white/30 text-white hover:bg-white/10 bg-transparent border px-6 py-3 transition-all duration-300"
          (click)="router.navigate(['/register'])"
        >
          {{ isRtl ? 'إنشاء حساب' : 'Register' }}
        </button>
      </div>
    </div>
  </div>
</section>

<!-- Main Profile Content -->
<section *ngIf="studentData && isAuthenticated && !loading" class="relative isolate overflow-hidden">
  <div class="absolute inset-0 -z-10 animated-gradient opacity-90"></div>
  <div class="absolute inset-0 z-0 bg-black/55"></div>
  <div class="absolute -top-20 -left-20 w-72 h-72 bg-white/10 rounded-full blur-3xl hidden md:block"></div>
  <div class="absolute -bottom-24 -right-24 w-80 h-80 bg-black/10 rounded-full blur-3xl hidden md:block"></div>
  
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-14 md:py-20 lg:py-28 relative z-10" [dir]="isRtl ? 'rtl' : 'ltr'">
    <!-- Main Title -->
    <div class="text-center mb-16 animate-fade-in-up">
      <h1 class="text-4xl lg:text-6xl font-bold text-white mb-6 text-shadow">
        {{ isRtl ? 'الطالب' : 'Student' }}
      </h1>
      <p class="text-xl text-white/90 max-w-3xl mx-auto">
        {{ isRtl 
          ? 'مرحباً بك في حساب الطالب، تابع تقدمك وأداءك التعليمي'
          : 'Welcome to your student page, track your progress and educational performance'
        }}
      </p>
    </div>

    <!-- Student Basic Information -->
    <div class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-2xl p-8 mb-12 text-center animate-fade-in-scale hover-scale">
      <div class="w-32 h-32 mx-auto mb-6 rounded-full bg-white/20 flex items-center justify-center overflow-hidden profile-image">
        <img *ngIf="profileImageUrl" [src]="profileImageUrl" alt="avatar" class="w-full h-full object-cover" />
        <svg *ngIf="!profileImageUrl" class="w-16 h-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
        </svg>
      </div>
      
      <h2 class="text-3xl font-bold text-white mb-4">
        {{ studentData?.fullName || (studentData?.firstName + ' ' + studentData?.lastName).trim() }}
      </h2>
      
      <p class="text-white/80 mb-6">
        {{ studentData?.email }}
      </p>
      
      <p *ngIf="studentData" class="text-white/60 mb-4">
        {{ getEffectiveRole(studentData) }}
      </p>

      <!-- Buttons - Student sees only basic data and evaluations -->
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <button 
          (click)="router.navigate(['/settings'])"
          class="bg-white/20 hover:bg-white/30 text-white border-white/30 px-8 py-3 rounded-full transition-all duration-300 hover:scale-105 flex items-center gap-2"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          {{ isRtl ? 'الإعدادات' : 'Settings' }}
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
        
        <button 
          (click)="router.navigate(['/evaluations'])"
          class="bg-white/20 hover:bg-white/30 text-white border-white/30 px-8 py-3 rounded-full transition-all duration-300 hover:scale-105 flex items-center gap-2"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
          </svg>
          {{ isRtl ? 'التقييمات' : 'Evaluations' }}
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Progress Circles -->
    <div class="flex flex-col md:flex-row items-center justify-center gap-8 mb-12 w-full">
      <!-- Content Browsing Rate -->
      <div class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-2xl p-8 text-center animate-fade-in-scale hover-scale flex-1 max-w-md">
        <div class="flex items-center justify-center mb-6">
          <svg class="w-8 h-8 text-blue-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
          </svg>
          <h3 class="text-2xl font-bold text-white">
            {{ isRtl ? 'نسبة التصفح للمحتوى' : 'Content Browsing Rate' }}
          </h3>
        </div>
        
        <div class="relative inline-block mb-6">
          <svg [attr.width]="calculateCircleProgress(evaluation?.browsingRate || 0).size" 
               [attr.height]="calculateCircleProgress(evaluation?.browsingRate || 0).size" 
               class="transform -rotate-90">
            <!-- Background -->
            <circle
              [attr.cx]="calculateCircleProgress(evaluation?.browsingRate || 0).size / 2"
              [attr.cy]="calculateCircleProgress(evaluation?.browsingRate || 0).size / 2"
              [attr.r]="calculateCircleProgress(evaluation?.browsingRate || 0).radius"
              stroke="rgba(255,255,255,0.2)"
              stroke-width="8"
              fill="transparent"
            />
            <!-- Progress -->
            <circle
              [attr.cx]="calculateCircleProgress(evaluation?.browsingRate || 0).size / 2"
              [attr.cy]="calculateCircleProgress(evaluation?.browsingRate || 0).size / 2"
              [attr.r]="calculateCircleProgress(evaluation?.browsingRate || 0).radius"
              stroke="#60A5FA"
              stroke-width="8"
              fill="transparent"
              [attr.stroke-dasharray]="calculateCircleProgress(evaluation?.browsingRate || 0).circumference"
              [attr.stroke-dashoffset]="calculateCircleProgress(evaluation?.browsingRate || 0).remaining"
              stroke-linecap="round"
              class="transition-all duration-1000 ease-out circle-progress"
            />
          </svg>
          <div class="absolute inset-0 flex items-center justify-center">
            <div class="text-center">
              <div class="text-3xl font-bold text-white">
                {{ evaluation?.browsingRate || 0 }}%
              </div>
              <div class="text-sm text-white/70">
                {{ isRtl ? 'مكتمل' : 'Complete' }}
              </div>
            </div>
          </div>
        </div>
        
        <div class="flex items-center justify-center gap-2 text-white/80">
          <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
          </svg>
          <span>{{ isRtl ? 'مستوى جيد' : 'Good Level' }}</span>
        </div>
      </div>

      <!-- Absence Rate -->
      <div class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-2xl p-8 text-center animate-fade-in-scale hover-scale flex-1 max-w-md">
        <div class="flex items-center justify-center mb-6">
          <svg class="w-8 h-8 text-red-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          <h3 class="text-2xl font-bold text-white">
            {{ isRtl ? 'نسبة الغياب' : 'Absence Rate' }}
          </h3>
        </div>
        
        <div class="relative inline-block mb-6">
          <svg [attr.width]="calculateCircleProgress(evaluation?.absenceRate || 0).size" 
               [attr.height]="calculateCircleProgress(evaluation?.absenceRate || 0).size" 
               class="transform -rotate-90">
            <!-- Background -->
            <circle
              [attr.cx]="calculateCircleProgress(evaluation?.absenceRate || 0).size / 2"
              [attr.cy]="calculateCircleProgress(evaluation?.absenceRate || 0).size / 2"
              [attr.r]="calculateCircleProgress(evaluation?.absenceRate || 0).radius"
              stroke="rgba(255,255,255,0.2)"
              stroke-width="8"
              fill="transparent"
            />
            <!-- Progress -->
            <circle
              [attr.cx]="calculateCircleProgress(evaluation?.absenceRate || 0).size / 2"
              [attr.cy]="calculateCircleProgress(evaluation?.absenceRate || 0).size / 2"
              [attr.r]="calculateCircleProgress(evaluation?.absenceRate || 0).radius"
              stroke="#F87171"
              stroke-width="8"
              fill="transparent"
              [attr.stroke-dasharray]="calculateCircleProgress(evaluation?.absenceRate || 0).circumference"
              [attr.stroke-dashoffset]="calculateCircleProgress(evaluation?.absenceRate || 0).remaining"
              stroke-linecap="round"
              class="transition-all duration-1000 ease-out circle-progress"
            />
          </svg>
          <div class="absolute inset-0 flex items-center justify-center">
            <div class="text-center">
              <div class="text-3xl font-bold text-white">
                {{ evaluation?.absenceRate || 0 }}%
              </div>
              <div class="text-sm text-white/70">
                {{ isRtl ? 'غياب' : 'Absent' }}
              </div>
            </div>
          </div>
        </div>
        
        <div class="flex items-center justify-center gap-2 text-white/80">
          <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
          <span>{{ isRtl ? 'مستوى مقبول' : 'Acceptable Level' }}</span>
        </div>
      </div>
    </div>

    <!-- Additional Statistics -->
    <div class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-2xl p-8 animate-fade-in-up hover-scale">
      <h3 class="text-2xl font-bold text-white mb-6 text-center">
        {{ isRtl ? 'إحصائيات إضافية' : 'Additional Statistics' }}
      </h3>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="text-center stat-card">
          <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-green-500/20 flex items-center justify-center">
            <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div class="text-2xl font-bold text-white mb-2">
            {{ evaluation?.attendanceRate || 0 }}%
          </div>
          <div class="text-white/70">
            {{ isRtl ? 'نسبة الحضور' : 'Attendance Rate' }}
          </div>
        </div>
        
        <div class="text-center stat-card">
          <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-blue-500/20 flex items-center justify-center">
            <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
            </svg>
          </div>
          <div class="text-2xl font-bold text-white mb-2">
            {{ evaluation?.contentRatio || 0 }}%
          </div>
          <div class="text-white/70">
            {{ isRtl ? 'نسبة المحتوى' : 'Content Ratio' }}
          </div>
        </div>
        
        <div class="text-center stat-card">
          <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-purple-500/20 flex items-center justify-center">
            <svg class="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
            </svg>
          </div>
          <div class="text-2xl font-bold text-white mb-2">
            {{ getOverallAverage() }}%
          </div>
          <div class="text-white/70">
            {{ isRtl ? 'المعدل العام' : 'Overall Average' }}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
